

 R/check-cran.sh                                    |   4 -
 R/pkg/DESCRIPTION                                  |   2 +-
 R/pkg/R/RDD.R                                      |   2 +
 R/pkg/R/context.R                                  |   7 +
 .../test_includePackage.R                          |  24 +-
 R/pkg/tests/run-all.R                              |  38 +-
 R/run-tests.sh                                     |   5 +
 README.md                                          |  18 +
 assembly/pom.xml                                   |  25 +-
 build.gradle                                       |  64 +++
 build/mvn                                          |  18 +-
 build/sbt-launch-lib.bash                          |   4 +-
 .../org/apache/spark/util/kvstore/LevelDB.java     |  10 +-
 .../apache/spark/util/kvstore/LevelDBIterator.java |   7 +-
 .../apache/spark/util/kvstore/LevelDBTypeInfo.java |   6 +-
 .../apache/spark/util/kvstore/DBIteratorSuite.java |  12 +-
 .../apache/spark/util/kvstore/LevelDBSuite.java    |   7 +-
 .../network/RequestTimeoutIntegrationSuite.java    |   1 +
 .../KubernetesExternalShuffleClient.java           |  20 +-
 .../KubernetesExternalShuffleClientImpl.java       |  78 ++++
 .../shuffle/mesos/MesosExternalShuffleClient.java  |   2 +-
 .../shuffle/protocol/BlockTransferMessage.java     |   1 -
 .../protocol/{mesos => }/RegisterDriver.java       |   5 +-
 .../spark/network/yarn/YarnShuffleService.java     |  25 +-
 .../network/yarn/YarnShuffleServiceMetrics.java    | 171 ++++++++
 .../test/java/org/apache/spark/tags/FlakyTest.java |  23 +-
 .../test/scala/org/apache/spark/tags/Flaky.scala   |  15 +-
 core/pom.xml                                       |   4 +
 .../org/apache/spark/ui/static/executorspage.js    |  34 ++
 .../main/scala/org/apache/spark/SparkContext.scala |  33 +-
 .../src/main/scala/org/apache/spark/SparkEnv.scala |  56 ++-
 .../apache/spark/api/conda/CondaEnvironment.scala  | 176 ++++++++
 .../spark/api/conda/CondaEnvironmentManager.scala  | 244 +++++++++++
 .../apache/spark/api/java/JavaSparkContext.scala   |  17 +
 .../org/apache/spark/api/python/PythonRDD.scala    |   4 +-
 .../org/apache/spark/api/python/PythonRunner.scala |   9 +-
 .../spark/api/python/PythonWorkerFactory.scala     |  25 +-
 .../main/scala/org/apache/spark/api/r/RRDD.scala   |  11 +-
 .../scala/org/apache/spark/api/r/RRunner.scala     |  50 ++-
 .../main/scala/org/apache/spark/api/r/RUtils.scala |   6 +
 .../scala/org/apache/spark/deploy/Common.scala     |  45 ++
 .../org/apache/spark/deploy/CondaRunner.scala      |  80 ++++
 .../org/apache/spark/deploy/PythonRunner.scala     |  33 +-
 .../scala/org/apache/spark/deploy/RRunner.scala    |  44 +-
 .../spark/deploy/rest/RestSubmissionServer.scala   |  26 +-
 .../deploy/rest/SubmitRestProtocolMessage.scala    |   2 +-
 .../executor/CoarseGrainedExecutorBackend.scala    |   2 +-
 .../org/apache/spark/internal/config/package.scala |  37 ++
 .../org/apache/spark/metrics/MetricsSystem.scala   |  88 +++-
 .../org/apache/spark/rdd/RDDOperationScope.scala   |   4 +-
 .../apache/spark/scheduler/TaskSetManager.scala    |   2 +-
 .../cluster/CoarseGrainedClusterMessage.scala      |   2 +-
 .../cluster/CoarseGrainedSchedulerBackend.scala    |   2 +-
 .../spark/status/api/v1/JacksonMessageWriter.scala |   2 +-
 .../org/apache/spark/storage/BlockManager.scala    |  10 +-
 .../scala/org/apache/spark/DistributedSuite.scala  |   8 +-
 .../api/conda/CondaEnvironmentManagerTest.scala    |  46 +++
 .../apache/spark/metrics/MetricsSystemSuite.scala  |  38 +-
 .../scheduler/SparkListenerWithClusterSuite.scala  |   3 +-
 .../org/apache/spark/util/TempDirectory.scala      |  40 +-
 .../util/collection/ExternalSorterSuite.scala      |   3 +-
 dists/hadoop-palantir/pom.xml                      | 220 ++++++++++
 docs/cloud-integration.md                          |  13 +-
 docs/index.md                                      |   2 +-
 docs/running-on-kubernetes-cloud.md                |  24 ++
 docs/running-on-kubernetes.md                      | 179 ++++++++
 docs/storage-openstack-swift.md                    |   8 +-
 examples/pom.xml                                   |   5 -
 .../org/apache/spark/sql/avro/AvroFileFormat.scala |   1 -
 .../spark/streaming/flume/FlumeStreamSuite.scala   |   6 +-
 .../publish.gradle                                 |  37 +-
 gradle/wrapper/gradle-wrapper.jar                  | Bin 0 -> 54413 bytes
 gradle/wrapper/gradle-wrapper.properties           |  22 +
 gradlew                                            | 194 +++++++++
 hadoop-cloud/pom.xml                               |  98 ++---
 launcher/pom.xml                                   |   1 -
 .../apache/spark/launcher/AbstractLauncher.java    |   2 +-
 .../apache/spark/launcher/InProcessAppHandle.java  |   7 +
 .../apache/spark/launcher/InProcessLauncher.java   |   2 +-
 .../org/apache/spark/launcher/SparkLauncher.java   |   2 +-
 .../spark/launcher/SparkSubmitOptionParser.java    |   4 +
 .../JavaMultilayerPerceptronClassifierSuite.java   |   2 +
 .../scala/org/apache/spark/ml/ann/ANNSuite.scala   |   5 +-
 .../MultilayerPerceptronClassifierSuite.scala      |  12 +-
 .../spark/ml/classification/OneVsRestSuite.scala   |   2 +-
 .../classification/LogisticRegressionSuite.scala   |   5 +-
 .../spark/mllib/optimization/LBFGSSuite.scala      |  14 +-
 pom.xml                                            | 458 ++++++++++++++++++++-
 python/pyspark/context.py                          |  16 +-
 python/pyspark/java_gateway.py                     |   1 +
 python/pyspark/ml/tests.py                         |  17 +-
 python/pyspark/mllib/tests.py                      |  17 +-
 python/pyspark/rdd.py                              |   5 +-
 python/pyspark/sql/tests.py                        |  25 +-
 python/pyspark/sql/udf.py                          |   5 +-
 python/pyspark/streaming/tests.py                  |  22 +-
 python/pyspark/tests.py                            |  51 ++-
 python/run-tests.py                                |  44 +-
 .../scala/org/apache/spark/deploy/k8s/Config.scala |  36 ++
 .../org/apache/spark/deploy/k8s/Constants.scala    |  15 +-
 .../apache/spark/deploy/k8s/KubernetesConf.scala   |  24 ++
 .../spark/deploy/k8s/KubernetesDriverSpec.scala    |   7 -
 .../apache/spark/deploy/k8s/KubernetesUtils.scala  |  45 +-
 .../deploy/k8s/MountSmallFilesBootstrap.scala      |  48 +++
 .../k8s/features/BasicDriverFeatureStep.scala      |   8 +-
 .../k8s/features/BasicExecutorFeatureStep.scala    |  10 +-
 .../k8s/features/MountLocalFilesFeatureStep.scala  | 100 +++++
 .../k8s/features/PodTemplateConfigMapStep.scala    |  72 ++++
 .../k8s/submit/KubernetesClientApplication.scala   |   6 +-
 .../k8s/submit/KubernetesDriverBuilder.scala       |  78 +++-
 .../cluster/k8s/ExecutorPodsLifecycleManager.scala |   1 -
 .../cluster/k8s/KubernetesClusterManager.scala     |  13 +-
 .../cluster/k8s/KubernetesExecutorBuilder.scala    |  32 +-
 .../k8s/features/BasicDriverFeatureStepSuite.scala |   6 +-
 .../features/BasicExecutorFeatureStepSuite.scala   |   3 +
 ...iverKubernetesCredentialsFeatureStepSuite.scala |   3 +
 .../features/DriverServiceFeatureStepSuite.scala   |   6 +
 .../k8s/features/EnvSecretsFeatureStepSuite.scala  |   1 +
 .../k8s/features/LocalDirsFeatureStepSuite.scala   |   1 +
 .../features/MountLocalFilesFeatureStepSuite.scala | 115 ++++++
 .../features/MountSecretsFeatureStepSuite.scala    |   1 +
 .../features/MountVolumesFeatureStepSuite.scala    |   1 +
 .../features/PodTemplateConfigMapStepSuite.scala   |  97 +++++
 .../bindings/JavaDriverFeatureStepSuite.scala      |   1 +
 .../bindings/PythonDriverFeatureStepSuite.scala    |   2 +
 .../bindings/RDriverFeatureStepSuite.scala         |   1 +
 .../spark/deploy/k8s/submit/ClientSuite.scala      |   1 +
 .../k8s/submit/KubernetesDriverBuilderSuite.scala  | 171 +++++++-
 .../deploy/k8s/submit/PodBuilderSuiteUtils.scala   | 142 +++++++
 .../cluster/k8s/ExecutorPodsAllocatorSuite.scala   |   2 +-
 .../k8s/ExecutorPodsLifecycleManagerSuite.scala    |   4 -
 .../k8s/KubernetesExecutorBuilderSuite.scala       |  71 +++-
 .../docker/src/main/dockerfiles/spark/Dockerfile   |   5 +-
 .../src/main/dockerfiles/spark/entrypoint.sh       |   3 +
 .../src/test/resources/driver-template.yml         |  26 ++
 .../src/test/resources/executor-template.yml       |  26 ++
 .../k8s/integrationtest/KubernetesSuite.scala      |   3 +-
 .../k8s/integrationtest/PodTemplateSuite.scala     |  56 +++
 .../deploy/mesos/MesosExternalShuffleService.scala |   3 +-
 .../spark/deploy/yarn/BaseYarnClusterSuite.scala   |   5 +-
 .../spark/deploy/yarn/YarnClusterSuite.scala       |  94 +++++
 .../yarn/YarnShuffleServiceMetricsSuite.scala      | 113 +++++
 sbin/build-push-docker-images.sh                   |  72 ++++
 .../KubernetesDriverSpec.scala => settings.gradle  |  15 +-
 spark-docker-image-generator/.gitignore            |   3 +
 spark-docker-image-generator/build.gradle          |  65 +++
 .../plugin-test-project/.gitignore                 |   1 +
 .../plugin-test-project/build.gradle               |  40 +-
 .../java/org/apache/spark/test/HelloWorld.java     |  21 +-
 .../kubernetes/docker/gradle/DockerBuildTask.java  |  73 ++++
 .../docker/gradle/GenerateDockerFileTask.java      |  91 ++++
 .../kubernetes/docker/gradle/LazyExecTask.java     |  38 +-
 .../docker/gradle/SparkDockerExtension.java        |  70 ++++
 .../docker/gradle/SparkDockerPlugin.java           | 178 ++++++++
 ...park.deploy.kubernetes.docker.gradle.properties |  18 +
 .../docker/gradle/DockerBuildTaskSuite.java        |  83 ++++
 .../docker/gradle/GenerateDockerFileTaskSuite.java |  86 ++++
 .../docker/gradle/LazyExecTaskSuite.java           |  70 ++++
 .../kubernetes/docker/gradle/ProjectExecUtils.java |  25 +-
 .../docker/gradle/SparkDockerPluginSuite.java      | 131 ++++++
 .../src/test/resources/ExpectedDockerfile          |   7 +-
 .../spark/sql/catalyst/analysis/Analyzer.scala     |   2 +-
 .../spark/sql/catalyst/parser/ParseDriver.scala    |  13 +-
 .../org/apache/spark/sql/internal/SQLConf.scala    |  31 +-
 .../apache/spark/sql/internal/StaticSQLConf.scala  |  12 +-
 .../sql/catalyst/parser/ErrorParserSuite.scala     |  22 +-
 .../parquet/SpecificParquetRecordReaderBase.java   |  45 +-
 .../scala/org/apache/spark/sql/SparkSession.scala  |   6 +-
 .../spark/sql/execution/DataSourceScanExec.scala   | 101 +++--
 .../execution/datasources/CatalogFileIndex.scala   | 119 ++----
 .../sql/execution/datasources/DataSource.scala     |   6 +-
 .../sql/execution/datasources/FileFormat.scala     |  13 +
 ...gFileIndex.scala => HiveCatalogFileIndex.scala} |  12 +-
 .../datasources/parquet/ParquetFileFormat.scala    |  89 +++-
 .../datasources/parquet/ParquetFileSplitter.scala  | 159 +++++++
 .../datasources/parquet/ParquetFilters.scala       | 183 ++++++--
 .../parquet/ParquetSchemaConverter.scala           |   4 +-
 .../datasources/parquet/ParquetWriteSupport.scala  |   7 +-
 .../org/apache/spark/sql/execution/limit.scala     |   3 +
 .../org/apache/spark/sql/execution/objects.scala   |   8 +-
 .../sql/execution/r/MapPartitionsRWrapper.scala    |  12 +-
 .../apache/spark/sql/internal/SharedState.scala    |   1 +
 .../results/describe-part-after-analyze.sql.out    |  12 +-
 .../org/apache/spark/sql/CachedTableSuite.scala    |   2 +-
 .../spark/sql/FileBasedDataSourceSuite.scala       |   7 +-
 .../scala/org/apache/spark/sql/JoinSuite.scala     |  33 +-
 .../scala/org/apache/spark/sql/SQLQuerySuite.scala |   8 +
 .../benchmark/FilterPushdownBenchmark.scala        |   2 +-
 .../columnar/InMemoryColumnarQuerySuite.scala      |   4 +-
 .../spark/sql/execution/command/DDLSuite.scala     |   4 +-
 .../datasources/FileSourceStrategySuite.scala      |  35 +-
 .../datasources/HadoopFsRelationSuite.scala        |   2 +-
 .../datasources/parquet/ParquetFilterSuite.scala   | 112 +++--
 .../parquet/ParquetInteroperabilitySuite.scala     |  17 +-
 .../datasources/parquet/ParquetQuerySuite.scala    | 170 +++++++-
 .../python/BatchEvalPythonExecSuite.scala          |   3 +-
 .../apache/spark/sql/internal/SQLConfSuite.scala   |  14 +-
 .../spark/sql/streaming/StreamingJoinSuite.scala   |   9 +-
 .../StreamingSymmetricHashJoinHelperSuite.scala    |  11 +-
 .../org/apache/spark/sql/test/SQLTestUtils.scala   |   5 +-
 .../spark/sql/hive/thriftserver/CliSuite.scala     |   3 +-
 .../execution/HiveWindowFunctionQuerySuite.scala   |  10 +
 sql/hive/pom.xml                                   |   4 -
 .../spark/sql/hive/HiveMetastoreCatalog.scala      |   2 +-
 .../sql/hive/client/IsolatedClientLoader.scala     |   3 +-
 .../apache/spark/sql/hive/CachedTableSuite.scala   |   6 +-
 .../sql/hive/ClasspathDependenciesSuite.scala      |   4 -
 .../spark/sql/hive/HiveSparkSubmitSuite.scala      |   6 +-
 .../execution/PruneFileSourcePartitionsSuite.scala |   4 +-
 .../spark/sql/hive/execution/SQLQuerySuite.scala   |   4 +-
 .../org/apache/spark/sql/hive/parquetSuites.scala  |  82 ++--
 .../spark/streaming/StreamingContextSuite.scala    |   8 +-
 versions.props                                     |  24 ++
 213 files changed, 6375 insertions(+), 936 deletions(-)
